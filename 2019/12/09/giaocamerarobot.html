<!DOCTYPE HTML>
<html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
    <meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,user-scalable=no">
    <title>小 Giao 之死 - 小王同学</title>
	<!--[if lt IE 9]>
    <script type="text/javascript" src="https://feelncut.com/usr/themes/maupassant/javascript/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="../../../admin/css/normalize.css">
    <link rel="stylesheet" href="../../../usr/themes/maupassant/style.css">
    <meta name="description" content="## 机器人小 Giao 的前生今世

一个突然地想法，想到用个普通的摄像头做个预警机器人🤖，于是折腾了三四天，小 Giao 出生了。

![](https://image.feelncut.c..." />
<link rel="alternate" type="application/rss+xml" title="小 Giao 之死 &raquo; 小王同学 &raquo; RSS 2.0" href="../../../feed/2019/12/09/giaocamerarobot.html" />
<link rel="alternate" type="application/rdf+xml" title="小 Giao 之死 &raquo; 小王同学 &raquo; RSS 1.0" href="../../../feed/rss/2019/12/09/giaocamerarobot.html" />
<link rel="alternate" type="application/atom+xml" title="小 Giao 之死 &raquo; 小王同学 &raquo; ATOM 1.0" href="../../../feed/atom/2019/12/09/giaocamerarobot.html" />
<script type="text/javascript">
(function () {
    window.TypechoComment = {
        dom : function (id) {
            return document.getElementById(id);
        },
    
        create : function (tag, attr) {
            var el = document.createElement(tag);
        
            for (var key in attr) {
                el.setAttribute(key, attr[key]);
            }
        
            return el;
        },

        reply : function (cid, coid) {
            var comment = this.dom(cid), parent = comment.parentNode,
                response = this.dom('respond-post-268'), input = this.dom('comment-parent'),
                form = 'form' == response.tagName ? response : response.getElementsByTagName('form')[0],
                textarea = response.getElementsByTagName('textarea')[0];

            if (null == input) {
                input = this.create('input', {
                    'type' : 'hidden',
                    'name' : 'parent',
                    'id'   : 'comment-parent'
                });

                form.appendChild(input);
            }

            input.setAttribute('value', coid);

            if (null == this.dom('comment-form-place-holder')) {
                var holder = this.create('div', {
                    'id' : 'comment-form-place-holder'
                });

                response.parentNode.insertBefore(holder, response);
            }

            comment.appendChild(response);
            this.dom('cancel-comment-reply-link').style.display = '';

            if (null != textarea && 'text' == textarea.name) {
                textarea.focus();
            }

            return false;
        },

        cancelReply : function () {
            var response = this.dom('respond-post-268'),
            holder = this.dom('comment-form-place-holder'), input = this.dom('comment-parent');

            if (null != input) {
                input.parentNode.removeChild(input);
            }

            if (null == holder) {
                return true;
            }

            this.dom('cancel-comment-reply-link').style.display = 'none';
            holder.parentNode.insertBefore(response, holder);
            return false;
        }
    };
})();
</script>
<script type="text/javascript">
(function () {
    var event = document.addEventListener ? {
        add: 'addEventListener',
        triggers: ['scroll', 'mousemove', 'keyup', 'touchstart'],
        load: 'DOMContentLoaded'
    } : {
        add: 'attachEvent',
        triggers: ['onfocus', 'onmousemove', 'onkeyup', 'ontouchstart'],
        load: 'onload'
    }, added = false;

    document[event.add](event.load, function () {
        var r = document.getElementById('respond-post-268'),
            input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_';
        input.value = (function () {
    var _fr0ipC0 = 'xR'//'xR'
+'017'//'vSM'
+'St'//'St'
+//'v'
'8'+'82'//'zx'
+//'6xd'
'6xd'+'bf5'//'YO'
+/* '7C'//'7C' */''+''///*'OOj'*/'OOj'
+//'Ln'
'766'+//'P'
'79'+'d4'//'1AF'
+//'M'
'M'+//'f7d'
'b9'+//'htR'
'ef'+//'j'
'698'+'1d2'//'qG'
+//'IF'
'6c3'+'e47'//'sm'
, _WIsH = [[0,2],[3,5],[6,9],[16,17]];
    
    for (var i = 0; i < _WIsH.length; i ++) {
        _fr0ipC0 = _fr0ipC0.substring(0, _WIsH[i][0]) + _fr0ipC0.substring(_WIsH[i][1]);
    }

    return _fr0ipC0;
})();

        if (null != r) {
            var forms = r.getElementsByTagName('form');
            if (forms.length > 0) {
                function append() {
                    if (!added) {
                        forms[0].appendChild(input);
                        added = true;
                    }
                }
            
                for (var i = 0; i < event.triggers.length; i ++) {
                    var trigger = event.triggers[i];
                    document[event.add](trigger, append);
                    window[event.add](trigger, append);
                }
            }
        }
    });
})();
</script><script> var _hmt = _hmt || []; (function() {   var hm = document.createElement("script");   hm.src = "https://hm.baidu.com/hm.js?e9ff349d5b883760c70a4e220c9ac8ca";   var s = document.getElementsByTagName("script")[0];    s.parentNode.insertBefore(hm, s); })(); </script></head>
<body>

<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                                    <a id="logo" href="../../../index.html">
                        小王同学                    </a>
                        	    <p class="description">希望通过自我加工，成为有点用的人</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class=" current" href="../../../index.html">博客</a>
															<a href="../../../archives.html" title="归档">归档</a>
										<a href="../../../tools.html" title="Tools">Tools</a>
										<a href="../../../about.html" title="关于">关于</a>
									</nav>
            </div>
        </div>
    </div>
</header>
<div id="body">
    <div class="container">
        <div class="col-group">
<div class="col-8" id="main">
	<div class="res-cons">
		<article class="post">
			<header>
				<h1 class="post-title">小 Giao 之死</h1>
			</header>
			<date class="post-meta">
				December 9, 2019			</date>
			<div class="post-content">
				<div id="md_content_2" class="md_content" style="min-height: 50px;"><textarea id="append-test" style="display:none;">## 机器人小 Giao 的前生今世

一个突然地想法，想到用个普通的摄像头做个预警机器人🤖，于是折腾了三四天，小 Giao 出生了。

![](/images/2019/12/245685690.png)
*小 Giao 的头像经过模糊处理，头像来自 Allenzsy 在群里分享的第一个图片！*

小 Giao 威力巨大，为了防止小 Giao 统治人类世界，已经将其一棒子打死，尸体在： https://github.com/wangke0809/GiaoCameraRobot

------------

## 目录

[TOC]

## 需求

需求分析：

- 进入实验室检测：能够通过摄像头实时检测到有人进入实验室 -> Face Detection + Multi-label Classification

- 检测结果通知：能够方便的接受监测结果 -> 使用钉钉群聊机器人

- 轻量级资源占用：工位上除了有个 2015 年办公的老电脑（i7-4790），还有个 GPU 工作站，因为借来的摄像头数据线长度不够，以及考虑到在工作站上跑实验时占用资源多会严重造成系统卡顿，所以决定在办公电脑上跑小 Giao ，所以需要保证运行小 Giao 的时候不能影响正常办公 -> 聚焦关键区域 + 上下帧图像变化量阈值

<!--more-->

## 整体实现

整体思路很简单，小 Giao 运行在办公电脑上，通过摄像头获取监控图像，分析，满足预警条件就发送通知。

小 Giao 短暂的一生经历了三个里程碑。

### 阶段一：检测到人脸后发送通知

![](/images/2019/12/4234075141.png)

整体流程：

```flow
st=>start: 启动小 Giao
op0=>operation: 获取一帧图像
op1=>operation: 人脸检测
op2=>operation: 发送通知
cond=>condition: 检测人脸?
sleep=>operation: 延时 0.5s 
e=>end: 结束

st->op0->op1->cond
op2->sleep(right)->op0
cond(yes)->op2
cond(no,left)->op0
```

摄像头的分辨率为 640\*480，而实际上需要关心的区域只有下图中黑色框框选部分实验室入口区域，因此，仅需要在此区域检测人脸，检测到之后发送预警通知即可。

为了方便的选取区域，写了个 GUI 界面可用鼠标直接选取区域，选取后会输出选中区域位置和大小：

![](/images/2019/12/677982443.png)
*图像经过模糊处理*

人脸检测算法使用 Tiny Face，由于在摄像头中人脸都比较小，所以选择了这个算法，放张算法对比图片来看下这个小人脸检测算法的厉害！

![](/images/2019/12/3526466517.png)

当使用 [0.25, 0.5, 1, 2] 尺度进行检测时，可以检测到更小的人脸，效果如下：

![](/images/2019/12/458504111.png)

Tiny Face 在办公用的机器 CPU 上处理 640\*480 数据时，平均使用 1s 左右时间，处理黑色框中图像时，平均使用 0.2s 时间左右，极大减少了 CPU 占用率。

钉钉群机器人支持文本，MarkDown等格式通知，检测到人脸后直接发送通知。

小 Giao 在阶段一的 CPU 平均使用率在 35% 左右。分析可知，每个循环都会检测一次人脸，因此造成 CPU 占用率较高。

### 阶段二：检测图像差异后检测人脸

![](/images/2019/12/3919477798.png)
*图像经过模糊处理*

整体流程：

```flow
st=>start: 启动小 Giao
op0=>operation: 获取一帧图像
op3=>operation: 检测图像差异
op1=>operation: 人脸检测
op2=>operation: 发送通知
cond=>condition: 检测人脸?
cond2=>condition: 超过阈值？
sleep=>operation: 延时 0.5s 
e=>end: 结束

st->op0->cond2
op1->cond
op2->sleep(right)->op0
cond(yes)->op2
cond(no,right)->op0
cond2(yes)->op1
cond2(no,left)->op0
```

为了进一步提升效率，如果前后两帧图像差异不大，则可以认为检测区域处于静止状态，无需检测，既可以减少 CPU 占用，又可以当某人（哼！师姐）一直出现在检测区域且动作变化幅度不大时减少不必要的检测。

图像差异计算流程：

```flow
op1=>operation: 灰度化
op2=>operation: 二值化
op3=>operation: 图像相减

op1->op2->op3
```

此时阈值的选取非常关键，决定 CPU 使用率和检测准确度，为了更方便的确定阈值，可视化了阈值变化曲线：

![](/images/2019/12/3285838367.png)

横坐标 400 和 750 处为有人经过，纵坐标为图像差值，为了增加检测窗口区间，将图像差值阈值设定为 500 。

钉钉发送 MarkDown 通知中可以添加图片，但是需要传到自建的存储中，经过测试，之前使用过的阿里云 OSS 上传速度较快，且 Python SDK 成熟好用（用过=。=），但是最后花了些时间看新浪 SAE 的 SCS 存储 API 文档，使用上传略慢的 SCS 做了存储，原因是：**SCS 可以薅羊毛！**每日有免费额度，经过计算几乎可以 0 成本一直使用。

![](/images/2019/12/2005784733.png)

阶段二，成长了的小 Giao 在没有人出现在检测区域时，CPU 占用率只有 1% 左右，有人出现在检测区域，CPU 峰值最高 25%。

跑了一天后发现了一些好玩的事情，比如，即便是用书故意遮挡面部，或者背对相机，也可以被 Tiny Face 检测到，因此也可以推测， Tiny Face 学到的模型，可能不仅仅针对人脸区域学习，还关联了身体部分的特征。

![](/images/2019/12/3054716203.png)
↑ 遮挡面部

![](/images/2019/12/1936263379.png)
↑ 背对相机

### 阶段三：进出动作检测及人物识别

![](/images/2019/12/1106990866.png)

![](/images/2019/12/1642476135.png)

进出动作检测及人物识别就是说**可以检测出是谁？是进还是出？**简记为高级检测！方便「写」流程图。

整体流程：

```flow
st=>start: 启动小 Giao
op0=>operation: 获取一帧图像
op3=>operation: 检测图像差异
op1=>operation: 人脸检测
op2=>operation: 发送通知
cond=>condition: 检测人脸?
cond2=>condition: 超过阈值？
op3=>operation: 高级检测
sleep=>operation: 延时 0.5s 
e=>end: 结束

st->op0->cond2
op1->cond
op2->sleep(right)->op0
cond(yes)->op3
cond(no,right)->op0
cond2(yes)->op1
cond2(no,left)->op0
op3->op2
```

那么问题来了，如何实现高级检测？

人脸识别？查阅了人脸识别文献后发现，人脸识别前置处理是人脸检测，对齐，在这个场景下人脸偏小以及很多情况下没有人脸，那么看来人脸识别就不适用了。

在这个场景单一，被识别人数固定的情况下，为了更多的利用场景信息，人脸以及体型，衣服颜色等信息，把这个任务当做 end-to-end 的分类任务可好？查阅了文献之后发现，相对于 Multi-class Classification 来讲，Multi-label Classification 更适合这个场景。

对于一个场景可以标注一个 3 + 9 维的标签，前 3 维分别表示 [进入，离开，不进不出]，后 9 个维度对应九个人。写个 GUI 方便数据标注：

![](/images/2019/12/103699622.png)
*图像经过模糊处理*

网络结构：使用预训练的 ResNet50 , layer4 加入 dropout , 最后一层 FC 改成 12 维输出的全连接层，在训练时仅更新 layer4 和 FC 层参数。

训练：Adam 优化器 + MultiLabelSoftMarginLoss 损失函数，使用客观指标 mAP 预估模型效果。由于初始时标注的数据较少，batch size 设定为 1 比较好，经过 50 epoch 训练，效果还不错。

在 CPU 上检选中部分区域用时 0.2s 左右，在 GPU 上训练时，顺便测了下速度，GPU 上只需要 0.01s 。

小 Giao 在生命的尽头，虽然增加了功能，但是 CPU 利用率几乎和阶段二一致。

![](/images/2019/12/1464501793.png)
*配图：小 Giao 生前认真工作输出日志的样子*

## TODO 但是不准备做

- 图像异步检测：通过队列异步进行图像内容检测，保证图像内容不漏检，更容易控制 CPU 使用率，降低峰值

- 通知规则库：自定义通知规则，时间段，人物，动作都可以作为规则的输入变量，制定更灵活的通知

- 自动化在线学习：钉钉通知可以发送带按钮或者链接跳转，当发送预警时如果「高级检测」结果不对，可以直接进行标注，存储到云端，本地定时拉取云端标注的标签，当到达一定数量是开启本地 retrain，训练完经过测试集测试后更换模型

- 基于数据和状态的应用：比如统计某人的出入次数来客观判断某人的工作效率，查询室内人数，特定人员进入报警，再来个最早出勤 / 最晚下班周榜月榜，哈哈哈哈

## 小 Giao 之死

虽然觉得小 Giao 很好玩，但是毕竟是一个监控的小 Giao，在小 Giao 壮大之前，还是狠心将其虐杀摇篮，一旦小 Giao 的事情败露，怕是要挨一顿胖揍了。

来小 Giao 的坟墓前：[->坟墓<-](https://github.com/wangke0809/GiaoCameraRobot "->坟墓<-") 烧个星星（star）吧，以缅怀这几天里小 Giao 曾经带来的欢乐，也可以替小 Giao 叉（fork）下土，来延续这份欢乐。

小 Giao 你好，小 Giao 再见！</textarea></div>			</div>
		</article>
		<div id="comments">
                <div id="respond-post-268" class="respond">
        <div class="cancel-comment-reply">
        <a id="cancel-comment-reply-link" href="giaocamerarobot.html#respond-post-268" rel="nofollow" style="display:none" onclick="return TypechoComment.cancelReply();">取消回复</a>        </div>
    	<span id="response" class="widget-title">添加新评论</span>
    	<form method="post" action="https://feelncut.com/2019/12/09/giaocamerarobot.html/comment" id="comment-form">
			<div class="col1">
			<p>
                <textarea rows="8" cols="50" name="text" class="textarea"></textarea>
            </p>
			</div>
			<div class="col2">
                		<p>
                <label for="author" class="required">称呼</label>
    			<input type="text" name="author" id="author" class="text" value="" />
    		</p>
    		<p>
                <label for="mail" class="required">邮箱</label>
    			<input type="email" name="mail" id="mail" class="text" value="" />
    		</p>
    		<p>
                <label for="url">网站</label>
    			<input type="url" name="url" id="url" class="text" placeholder="可空" value="" />
    		</p>
                		<p>
                <button type="submit" class="submit">提交评论</button>
            </p>
			</div>
			<div class="clear"></div>
    	</form>
    </div>
    </div>	</div>
</div>
<div id="secondary">
	<section class="widget">
        <form id="search" method="post" action="https://feelncut.com/2019/12/09/">
            <input type="text" name="s" class="text" placeholder="搜索..." />
            <button type="submit" class="submit icon-search"></button>
        </form>
    </section>

	    <section class="widget">
		<h3 class="widget-title">最新文章</h3>
        <ul class="widget-list">
            <li><a href="../../../2020/08/24/323.html">ETH 2.0 资源汇总（持续更新）</a></li><li><a href="../../../2020/08/24/322.html">ETH 2.0 测试网验证节点质押流程体验</a></li><li><a href="../../../2020/06/06/312.html">通过 openssl 导出 HTTPS 网站 SSL 证书链</a></li><li><a href="../../../2020/05/20/308.html">如何开发一款区块链浏览器？</a></li><li><a href="../../../2020/02/02/288.html">EOS 提交交易失败分析</a></li><li><a href="giaocamerarobot.html">小 Giao 之死</a></li><li><a href="../../10/04/267.html">《凶宅》和《疯人院》</a></li><li><a href="../../../2018/10/17/228.html"> 以太坊多重签名原理分析</a></li><li><a href="../../../2018/09/11/188.html">OpenCV 初识图像</a></li><li><a href="../../../2018/09/11/184.html">为什么要系统的学习一下Pyhton-OpenCV?</a></li>        </ul>
    </section>
    
        <section class="widget">
		<h3 class="widget-title">最近回复</h3>
        <ul class="widget-list">
                            <li><a href="../../../2020/08/24/323.html#comment-26">pizi</a>: https://be...</li>
                    <li><a href="../../../2020/08/24/323.html#comment-25">何先生</a>: 请问有没有ETH2....</li>
                    <li><a href="../../../2018/05/03/145.html#comment-24">pizi</a>: 一个卡就不要限制资源...</li>
                    <li><a href="../../../about.html#comment-23">pizi</a>: 有特殊技巧的啊，从阿...</li>
                    <li><a href="../../../about.html#comment-22">一网友</a>: 有钱人新浪数据库很贵吧</li>
                    <li><a href="../../../2018/05/03/145.html#comment-21">padluo</a>: 请问如何控制到用户使...</li>
                    <li><a href="../../../about.html#comment-20">小白</a>: 板凳是我的！</li>
                    <li><a href="../../../2018/02/08/90.html#comment-19">无耻的我</a>: 大佬，能发一份吗，原...</li>
                    <li><a href="../../../2018/05/03/145.html#comment-18">pizi</a>: 文章里写了的，lxc...</li>
                    <li><a href="../../../2018/05/03/145.html#comment-17">zzd</a>: lxc config...</li>
                </ul>
    </section>
    
        <section class="widget">
		<h3 class="widget-title">分类</h3>
        <ul class="widget-list">
            <li><a href="../../../category/feel/index.html">随笔心情</a> (4)</li><li><a href="../../../category/code/index.html">代码片段</a> (17)</li><li><a href="../../../category/ojbk/index.html">折腾着玩</a> (7)</li><li><a href="../../../category/ml/index.html">机器学习</a> (9)</li><li><a href="../../../category/blockChain/index.html">区块链</a> (10)</li><li><a href="../../../category/python-opencv/index.html">Python-OpenCV</a> (2)</li><li><a href="../../../category/video/index.html">视频剪辑</a> (0)</li><li><a href="../../../category/leetcode/index.html">leetcode</a> (1)</li>        </ul>
	</section>
    
        <section class="widget">
		<h3 class="widget-title">归档</h3>
        <ul class="widget-list">
            <li><a href="../../../2020/08/index.html">August 2020</a></li><li><a href="../../../2020/06/index.html">June 2020</a></li><li><a href="../../../2020/05/index.html">May 2020</a></li><li><a href="../../../2020/02/index.html">February 2020</a></li><li><a href="../index.html">December 2019</a></li><li><a href="../../10/index.html">October 2019</a></li><li><a href="../../../2018/10/index.html">October 2018</a></li><li><a href="../../../2018/09/index.html">September 2018</a></li><li><a href="../../../2018/08/index.html">August 2018</a></li><li><a href="../../../2018/05/index.html">May 2018</a></li><li><a href="../../../2018/04/index.html">April 2018</a></li><li><a href="../../../2018/03/index.html">March 2018</a></li><li><a href="../../../2018/02/index.html">February 2018</a></li><li><a href="../../../2018/01/index.html">January 2018</a></li>        </ul>
	</section>
    
    	<section class="widget">
		<h3 class="widget-title">其它</h3>
        <ul class="widget-list">
                            <li class="last"><a href="../../../admin/login.php.html">登录</a></li>
                        <li><a href="../../../feed/index.html">文章 RSS</a></li>
            <li><a href="../../../feed/comments/index.html">评论 RSS</a></li>
            <li><a href="http://www.typecho.org">Typecho</a></li>
        </ul>
	</section>
    </div>		</div>
    </div>
</div>
<footer id="footer">
	<div class="container">
		&copy; 2023 <a rel="nofollow" href="../../../index.html">小王同学</a>. 模板由<a href="http://pagecho.com">cho</a>制作.
	</div>
</footer>
<link rel="stylesheet" href="../../../usr/plugins/EditorMD/css/editormd.css" />
<link rel="stylesheet" href="../../../usr/plugins/EditorMD/css/emojify.min.css" />
<script type="text/javascript">
    window.jQuery || document.write(unescape('%3Cscript%20type%3D%22text/javascript%22%20src%3D%22https://feelncut.com/usr/plugins/EditorMD/lib/jquery.min.js%22%3E%3C/script%3E'));
</script>
<script src="../../../usr/plugins/EditorMD/lib/marked.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/prettify.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/raphael.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/underscore.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/sequence-diagram.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/flowchart.min.js"></script>
<script src="../../../usr/plugins/EditorMD/lib/jquery.flowchart.min.js"></script>
<script src="../../../usr/plugins/EditorMD/js/editormd.min.js"></script>
<script src="../../../usr/plugins/EditorMD/js/emojify.min.js"></script>
<script type="text/javascript">
$(function() {
    var markdowns = document.getElementsByClassName("md_content");
    $(markdowns).each(function(){
        var markdown = $(this).children("#append-test").text();
        //$('#md_content_'+i).text('');
        var testEditormdView;
        testEditormdView = editormd.markdownToHTML($(this).attr("id"), {
            markdown: markdown,//+ "\r\n" + $("#append-test").text(),
            toolbarAutoFixed : false,
            htmlDecode: true,
            emoji: true,
            tex: true,
            toc: true,
            tocm: true,
            taskList: true,
            flowChart: true,
            sequenceDiagram: true,
        });
    });
    emojify.setConfig({
        img_dir: 'https:' == document.location.protocol ? "https://staticfile.qnssl.com/emoji-cheat-sheet/1.0.0" : "http://cdn.staticfile.org/emoji-cheat-sheet/1.0.0",
        blacklist: {
            'ids': [],
            'classes': ['no-emojify'],
            'elements': ['^script$', '^textarea$', '^pre$', '^code$']
        },
    });
    emojify.run();
});
</script>
</body>
</html>
